#importem tots els fitxers que contenen cada part del codi que necessitem
from UartClass import UartClass
import time
from rpi_motor import Car
from rpi_motor import Motor
from micropython import const
from machine import Pin
from myservo import myServo
from Ultrasonic_Ranging import getSonar

#declarem variables de les classes necessàries
receiver = UartClass(0) #per connectar ESP32 amb Pico
car = Car() #per connectar rodes i motor
servo=myServo() #per declarar el servo

#declarem els pins corresponents als sensors
sensor1=Pin(4,Pin.IN) #sensor dret
sensor2=Pin(5,Pin.IN) #sensor central
sensor3=Pin(6,Pin.IN) #sensor esquerre

#declarem els pins del motor
m1 = Motor(12, 13)
m2 = Motor(15, 14)
m3 = Motor(17, 16)
m4 = Motor(18, 19)

#inicialitzem l'angle del servo
servo.myServoWriteAngle(0)


#farem un bucle inifinit perquè faci el programa fins arribar al final de la línia o rebre per bluetooth stop.
while True:

#en cas que rebem un start des del bluetooth engegarem el programa
#if(receiver.is_started() == True):
    #car.move(25) #para comprobar que se mueve

#FALTARÀ COMPROVAR QUE FUNCIONA CADA PART PER SEPARAT
#FALTARÀ AJUNTAR TOTES LES PARTS (SEGUIR LINIA I ESQUIVAR OBJECTE)
#PART PER SEGUIR LINIA

    #FEM UN IF PER SI NO DETECTA CAP SENSOR?
    #if ():
        #print('cuidado')
        #car.move(0)
    if (sensor1.value()): #en cas que detecti sensor dret movem a l'esquerra
        print('detecta dreta')
        car.moveleft(25,0)
    if (sensor2.value()): #en cas que detecti sensor central continuem recte
        print('sigue linia')
        car.move(25)
    if (sensor3.value()): #en cas que dectecti sensor esquerre movem a la dreta
        print('detecta esquerra')
        car.moveright(25,0)
            
    
#PART PER ESQUIVAR L'OBJECTE
    #VOLEM PROVAR QUE GIRI EL SERVO
    servo.myServoWriteAngle(90) 
    time.sleep_ms(500)
    servo.myServoWriteAngle(0)

    
    servo.myServoWriteAngle(0) #canviar posició del servo
    time.sleep_ms(500)
    distance = getSonar()      #agafem la distància
    print('Distance: ',distance,'cm' )

    if distance < 50:          #detectem objecte
        print('esquivar')
        car.move(0)
        time.sleep_ms(500)
        car.moveright(25,50) #ENS HEM DE MIRAR COM DESPLAÇAR-SE AL COSTAT I CONTINUAR ENDAVANT
        car.move(25)
        #COM TORNEM A LA LINIA?

    servo.myServoWriteAngle(90) #canviar posició del servo
    time.sleep_ms(500)
    distance = getSonar()
    print('Distance: ',distance,'cm' )

    if distance < 50:
        print('esquivar')
        car.move(0)
        time.sleep_ms(500)
        car.moveleft(25,50)
        car.move(25)

    time.sleep_ms(1000)


